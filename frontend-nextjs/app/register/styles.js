export const styles = {
  container: {
    width: "100%",
    maxWidth: "1200px",
    height: "85vh",
    overflowY: "auto",
    background: "var(--card-bg)",
    boxShadow: "0 0 10px rgba(0,0,0,0.4)",
    textAlign: "center",
    fontFamily: '"Arial", sans-serif',
    color: "var(--card-text)",
    padding: "20px",
    borderRadius: "10px",
    margin: "0px auto",
    position: "fixed",
    top: "55%",
    left: "50%",
    transform: "translate(-50%, -50%)",
  },
  input: {
    width: "500px",
    maxWidth: "500px",
    padding: "12px",
    margin: "10px auto",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
    minHeight: "44px",
  },
  input123: {
    width: "100%",
    maxWidth: "200px",
    padding: "10px",
    margin: "10px 5px",
    borderRadius: "6px",
    border: "none",
    background: "var(--button-bg)",
    color: "var(--button-text)",
    fontSize: "16px",
    cursor: "pointer",
    minHeight: "44px",
  },
  input1: {
    width: "30%",
    padding: "8px",
    margin: "10px 5px",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  input24: {
    width: "30%",
    padding: "8px",
    margin: "10px 5px",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  input241: {
    width: "100%",
    padding: "10px",
    margin: "10px 5px",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  input4: {
    width: "32%",
    padding: "8px",
    margin: "10px 0px 0px 30px",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  input2: {
    width: "10%",
    padding: "4px",
    margin: "-30px 0px 0px 350px",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    display: "block",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  input3: {
    width: "30%",
    padding: "4px",
    margin: "10px 10px 0px 20px",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  smallInput1: {
    width: "10%",
    padding: "8px",
    margin: "10px 0px 0px 0px",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  smallInput11: {
    width: "10%",
    padding: "8px",
    margin: "10px 0px 0px 30px",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  register: {
    flex: 0.5,
    padding: "8px",
    margin: "20px 90px 10px 5px",
    borderRadius: "6px",
    border: "none",
    background: "var(--button-bg)",
    color: "var(--button-text)",
    fontSize: "16px",
    fontWeight: "bold",
    cursor: "pointer",
  },

  register1: {
    width: "100%",
    padding: "12px",
    margin: "10px 0",
    borderRadius: "6px",
    border: "none",
    background: "var(--button-bg)",
    color: "var(--button-text)",
    fontSize: "16px",
    fontWeight: "bold",
    cursor: "pointer",
  },
  button: {
    width: "100%",
    padding: "8px 20px",
    margin: "10px 0",
    borderRadius: "6px",
    border: "none",
    background: "var(--button-bg)",
    color: "var(--button-text)",
    fontSize: "16px",
    fontWeight: "bold",
    cursor: "pointer",
    minHeight: "36px",
  },
  button1: {
    width: "100%",
    maxWidth: "500px",
    padding: "12px 20px",
    margin: "10px auto",
    borderRadius: "6px",
    border: "none",
    background: "var(--button-bg)",
    color: "var(--button-text)",
    fontSize: "16px",
    fontWeight: "bold",
    cursor: "pointer",
    minHeight: "44px",
  },
  previousButton: {
    width: "100%",
    padding: "8px 20px",
    margin: "10px 0",
    borderRadius: "6px",
    border: "none",
    background: "#6c757d",
    color: "#fff",
    fontSize: "16px",
    fontWeight: "bold",
    cursor: "pointer",
    minHeight: "36px",
  },
  previousButton1: {
    width: "100%",
    maxWidth: "500px",
    padding: "12px 20px",
    margin: "10px auto",
    borderRadius: "6px",
    border: "none",
    background: "#6c757d",
    color: "#fff",
    fontSize: "16px",
    fontWeight: "bold",
    cursor: "pointer",
    minHeight: "44px",
  },
  // Edit Detail specific buttons with reduced height and width
  editDetailButton: {
    width: "100%",
    maxWidth: "400px",
    padding: "8px 20px",
    margin: "10px auto",
    borderRadius: "6px",
    border: "none",
    background: "var(--button-bg)",
    color: "var(--button-text)",
    fontSize: "16px",
    fontWeight: "bold",
    cursor: "pointer",
    minHeight: "36px",
  },
  editDetailPreviousButton: {
    width: "100%",
    maxWidth: "400px",
    padding: "8px 20px",
    margin: "10px auto",
    borderRadius: "6px",
    border: "none",
    background: "#6c757d",
    color: "#fff",
    fontSize: "16px",
    fontWeight: "bold",
    cursor: "pointer",
    minHeight: "36px",
  },
  previousButton8: {
    width: "100%",
    padding: "12px",
    margin: "10px 0",
    borderRadius: "6px",
    border: "none",
    background: "#6c757d",
    color: "#fff",
    fontSize: "16px",
    fontWeight: "bold",
    cursor: "pointer",
  },
  formContainer: {
    display: "flex",
    flexWrap: "wrap",
    gap: "20px",
    width: "100%",
  },
  leftColumn: {
    flex: 1,
    margin: "0px 0px -12px 0px",
    minWidth: "300px",
    display: "flex",
    flexDirection: "column",
  },
  rightColumn: {
    flex: 1,
    minWidth: "300px",
    display: "flex",
    flexDirection: "column",
  },

  smallInput: {
    width: "60px",
    padding: "8px",
    margin: "10px 0",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  fileInput: {
    width: "90%",
    padding: "12px",
    margin: "10px 0px 0px 30px",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  select: {
    width: "90%",
    padding: "12px",
    margin: "10px 0",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
  },
  textarea: {
    width: "90%",
    padding: "12px",
    margin: "10px 0",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "16px",
    resize: "vertical",
  },
  label: {
    display: "block",
    margin: "10px 0 5px 0",
    fontWeight: "bold",
    color: "var(--card-text)",
  },
  fieldRow: {
    display: "flex",
    alignItems: "center",
    gap: "15px",
    margin: "10px 0",
    width: "100%",
  },
  fieldLabel: {
    minWidth: "180px",
    maxWidth: "180px",
    fontWeight: "500",
    color: "var(--card-text)",
    fontSize: "14px",
    textAlign: "right",
    flexShrink: 0,
  },
  fieldInput: {
    width: "300px",
    maxWidth: "300px",
    padding: "10px",
    borderRadius: "6px",
    border: "1px solid var(--input-border)",
    background: "var(--input-bg)",
    color: "var(--input-text)",
    fontSize: "14px",
    minHeight: "40px",
  },
  
  referralHeading: {
    margin: "20px 0 20px 0",
    fontSize: "16px",
    color: "var(--card-text)",
  },
  referralHeading2: {
    margin: "20px 0 20px 0",
    fontSize: "16px",
    color: "var(--card-text)",
  },
};

export const defaultFormData = {
  name: "",
  email: "",
  phone: "",
  otherPhone: "",
  maritalStatus: "",
  fatherName: "",
  motherName: "",
  knownLanguages: "",
  yourTemple: "",
  yourDivision: "",
  reference: "",
  profileCreatedBy: "",
  password: "",
  confirmPassword: "",
  gender: "",
  updated: "",
  fatherOccupation: "",
  motherOccupation: "",
  nativePlace: "",
  houseNameAddress: "",
  presentResidence: "",
  brothers: "",
  brothersMarried: "",
  sisters: "",
  sistersMarried: "",
  referredBy: "",
  referralDetails1Name: "",
  referralDetails1Phone: "",
  referralDetails1Address: "",
  referralDetails2Name: "",
  referralDetails2Phone: "",
  referralDetails2Address: "",
  referralSource: "",
  referralCode: "",
  additionalInfo: "",
  willingnessToWork: "",
  fromAge: "",
  toAge: "",
  fromHeight: "",
  toHeight: "",
  diet: "",
  specialCases: "",
  height: "",
  complexion: "",
  weight: "",
  specialCasesDetails: "",
  educationQualification: "",
  occupationBusiness: "",
  workingPlace: "",
  educationDetails: "",
  workDetails: "",
  income: "",
  incomeType: "",
  otherEducation: "",
  otherOccupation: "",
  zodiacSign: "",
  ascendant: "",
  birthStar: "",
  affliction: "",
  placeOfBirth: "",
  Dasatype: "",
  dasaRemain: "",
  sooriyan: "",
  chandiran: "",
  sevai: "",
  budhan: "",
  viyazhan: "",
  sukkiran: "",
  sani: "",
  rahu: "",
  kethu: "",
  maanthi: "",
  lagnam: "",
  selectedRasi: "",
  dateOfBirthYear: "",
  dateOfBirthMonth: "",
  dateOfBirthDay: "",
  timeOfBirthHours: "",
  timeOfBirthMinutes: "",
  timeOfBirthSeconds: "",
  periodType: "",
  fullStreetAddress: "",
  city: "",
  state: "",
  district: "",
  country: "",
  postalCode: "",
  whatsAppNo: "",
  photo: null,
  educationQualification1: "",
  educationDetails1: "",
  occupationBusiness1: "",
  workingPlace1: "",
  otherEducation1: "",
  otherOccupation1: "",
  complexion1: "",
  personalPreference1: "",
  willingnessToWork1: "",
  dosham: "",
  nativePlaceHouseName: "",
  pincode: "",
};

const DB_NAME = "RegistrationDB";
const STORE_NAME = "registerFormData";
const DB_VERSION = 2;

// Helper to open DB
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = (event) => {
      console.error("IndexedDB error:", event.target.error);
      reject("Error opening database");
    };
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      // Clear old data to fix corruption issues
      if (db.objectStoreNames.contains(STORE_NAME)) {
        db.deleteObjectStore(STORE_NAME);
      }
      db.createObjectStore(STORE_NAME);
    };
    
    request.onsuccess = (event) => {
      resolve(event.target.result);
    };
  });
}

// Helper to sanitize data
const sanitizeData = (data) => {
  const sanitized = { ...data };
  Object.keys(defaultFormData).forEach(key => {
    if (typeof defaultFormData[key] === "string") {
      const val = sanitized[key];
      // Check if it is an object OR if it is the string "[object Object]"
      if ((val && typeof val === "object") || val === "[object Object]") {
        console.warn(`Sanitizing field ${key}: Expected string but got object/[object Object]. Resetting to empty string.`);
        sanitized[key] = "";
      }
    }
  });
  return sanitized;
};

export async function loadFormData() {
  try {
    const db = await openDB();
    return new Promise((resolve) => {
      const transaction = db.transaction([STORE_NAME], "readonly");
      const store = transaction.objectStore(STORE_NAME);
      const request = store.get("formData");
      
      request.onerror = () => {
        console.error("Error loading from IndexedDB");
        resolve({ ...defaultFormData });
      };
      
      request.onsuccess = () => {
        const result = request.result;
        if (!result) {
          console.log("loadFormData: No data in IndexedDB, checking localStorage...");
          // Fallback/Migration from localStorage
          try {
            const localData = localStorage.getItem("registerFormData");
            if (localData) {
              const parsed = JSON.parse(localData);
              // Migrate to IndexedDB
              const sanitizedParsed = sanitizeData({ ...defaultFormData, ...parsed });
              
              saveFormData(sanitizedParsed).then(() => {
                localStorage.removeItem("registerFormData"); // Clean up
              });
              
              // We need to process the photos like before
              if (sanitizedParsed.photos && Array.isArray(sanitizedParsed.photos)) {
                  sanitizedParsed.photos = sanitizedParsed.photos.map(photoData => {
                     if (photoData && typeof photoData === "object" && photoData.base64) {
                       const { base64, name, type } = photoData;
                       const byteString = atob(base64.split(",")[1]);
                       const mimeString = base64.split(",")[0].split(":")[1].split(";")[0];
                       const ab = new ArrayBuffer(byteString.length);
                       const ia = new Uint8Array(ab);
                       for (let i = 0; i < byteString.length; i++) {
                         ia[i] = byteString.charCodeAt(i);
                       }
                       const blob = new Blob([ab], { type: mimeString });
                       return new File([blob], name, { type });
                     }
                     return photoData;
                  });
              } else if (sanitizedParsed.photo && typeof sanitizedParsed.photo === "object" && sanitizedParsed.photo.base64) {
                  // Legacy single photo
                  const { base64, name, type } = sanitizedParsed.photo;
                  const byteString = atob(base64.split(",")[1]);
                  const mimeString = base64.split(",")[0].split(":")[1].split(";")[0];
                  const ab = new ArrayBuffer(byteString.length);
                  const ia = new Uint8Array(ab);
                  for (let i = 0; i < byteString.length; i++) {
                     ia[i] = byteString.charCodeAt(i);
                  }
                  const blob = new Blob([ab], { type: mimeString });
                  sanitizedParsed.photo = new File([blob], name, { type });
              }
              resolve(sanitizedParsed);
              return;
            }
          } catch (e) {
             console.error("Migration error", e);
          }
          resolve({ ...defaultFormData });
        } else {
          console.log("loadFormData: Data loaded from IndexedDB");
          const sanitizedResult = sanitizeData({ ...defaultFormData, ...result });
          resolve(sanitizedResult);
        }
      };
    });
  } catch (e) {
    console.error("loadFormData: Error", e);
    return { ...defaultFormData };
  }
}

export async function saveFormData(data) {
  try {
    console.log("saveFormData: Saving to IndexedDB...", data);
    const db = await openDB();
    
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_NAME], "readwrite");
      const store = transaction.objectStore(STORE_NAME);
      
      // We can store the File objects directly in IndexedDB!
      // No need for base64 conversion overhead.
      // However, we should ensure data is clean.
      
      const request = store.put(data, "formData");
      
      request.onerror = (e) => {
        console.error("Error saving to IndexedDB", e);
        reject(e);
      };
      
      request.onsuccess = () => {
        console.log("saveFormData: Successfully saved to IndexedDB");
        resolve();
      };
    });
  } catch (e) {
    console.error("saveFormData: Error", e);
  }
}

export async function clearFormData() {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_NAME], "readwrite");
      const store = transaction.objectStore(STORE_NAME);
      // Overwrite with defaultFormData to ensure clean state
      const request = store.put(defaultFormData, "formData");
      
      request.onerror = (e) => {
        console.error("Error clearing IndexedDB", e);
        reject(e);
      };
      
      request.onsuccess = () => {
        console.log("clearFormData: Successfully reset IndexedDB to defaults");
        // Also clear localStorage for completeness
        localStorage.removeItem("registerFormData");
        resolve();
      };
    });
  } catch (e) {
    console.error("clearFormData: Error", e);
  }
}
